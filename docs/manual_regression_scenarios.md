# Ручной регрессионный прогон (подробный)

## 1. Цель и охват

Проверить вручную весь ключевой функционал приложения:

- авторизация и роли (`admin`/`operator`);
- справочники;
- поиск пациента, ЭМК, синхронизация контекста;
- ЭМЗ (создание, редактирование, версионирование, валидации);
- лаборатория пациента;
- санитарная микробиология;
- аналитика, отчеты, история артефактов и проверка хэшей;
- импорт/экспорт (Excel/CSV/ZIP/PDF);
- резервные копии и аудит.

## 2. Предусловия стенда

1. Запускать приложение на чистой копии БД или на заранее подготовленном тестовом стенде.
2. Проверить путь к БД:
   `C:\Users\user\AppData\Local\epid-control\epid-control\app.db`
3. Проверить, что миграции на `head`, и приложение стартует без ошибок.
4. Включить доступ к файловой системе для операций импорта/экспорта и бэкапа.

## 3. Тестовые учетные записи

Использовать отдельные тестовые логины:

- `admin_test` / `Admin123!` / роль `admin`
- `operator_test` / `Oper123!` / роль `operator`
- `blocked_test` / `Blocked123!` / роль `operator`, `is_active = false`

## 4. Базовые тестовые данные

### 4.1 Справочники

- Отделения:
  - `ICU-A`
  - `SURG-1`
- Типы материалов:
  - `BLOOD` / `Кровь`
  - `SPUTUM` / `Мокрота`
- ICD-10:
  - `A41.9` / `Сепсис неуточненный`
  - `J18.9` / `Пневмония неуточненная`
  - `T81.4` / `Инфекция после процедуры`
- Микроорганизмы:
  - `SAUR` / `Staphylococcus aureus`
  - `ECOL` / `Escherichia coli`
- Группы антибиотиков:
  - `BETA` / `Бета-лактамы`
  - `CARB` / `Карбапенемы`
- Антибиотики:
  - `CRO` / `Цефтриаксон` / группа `BETA`
  - `MEM` / `Меропенем` / группа `CARB`
- Бактериофаги:
  - `PHG-SA` / `Стафилококковый`
  - `PHG-EC` / `Коли-протейный`

### 4.2 Пациенты

- P1:
  - ФИО: `Иванов Иван Иванович`
  - ДР: `1985-04-12`
  - Пол: `M`
  - Категория: `Военнослужащий`
  - Часть: `в/ч 12345`
  - Округ: `ЦВО`
- P2:
  - ФИО: `Петров Петр Петрович`
  - ДР: `1992-11-03`
  - Пол: `M`
  - Категория: `Контракт`
  - Часть: `в/ч 67890`
  - Округ: `ЮВО`

### 4.3 Госпитализации и ЭМЗ

- C1 (для P1):
  - Номер и/б: `HC-2026-0001`
  - Отделение: `ICU-A`
  - Дата травмы: `2026-02-01`
  - Дата поступления: `2026-02-02`
  - Дата исхода: `2026-02-12`
  - Исход: `выписан`
  - SOFA: `5`
  - Диагнозы:
    - `admission` + `A41.9`
    - `complication` + `T81.4`
  - Антибиотики:
    - `Цефтриаксон`, `2026-02-02 09:00` - `2026-02-08 09:00`

## 5. Подготовка файлов для импорта (ручные фикстуры)

### 5.1 CSV `patients_import.csv`

Заголовок:
`id,full_name,dob,sex,category,military_unit,military_district`

Строки:
`101,Сидоров Сидор Сидорович,1987-01-01,M,Военнослужащий,в/ч 11111,ЦВО`
`102,Смирнов Семен Семенович,bad-date,M,Контракт,в/ч 22222,ЮВО`

### 5.2 Excel `patients_import.xlsx`

Лист `patients`, тот же набор колонок и 2 строки из CSV выше.

### 5.3 ZIP `import_ok.zip`

Содержимое:

- `manifest.json`
- `export.xlsx`

`manifest.json` должен содержать `schema_version` и `sha256` для `export.xlsx`.

### 5.4 ZIP `import_unsafe.zip`

Содержимое:

- запись с именем `../evil.txt` (для проверки защиты от Zip Slip).

## 6. Сценарии ручной проверки

## AUTH-01 Логин администратором

Шаги:
1. Открыть приложение.
2. Ввести `admin_test` / `Admin123!`.
3. Нажать `Войти`.

Ожидаемый результат:
1. Открывается главное окно.
2. В заголовке отображается логин и роль.
3. В `audit_log` появляется событие `login`.

## AUTH-02 Логин с неверным паролем

Шаги:
1. На форме входа ввести `admin_test` / `WrongPass!`.
2. Нажать `Войти`.

Ожидаемый результат:
1. Вход не выполняется.
2. Сообщение: `Неверный логин или пароль`.

## AUTH-03 Логин деактивированного пользователя

Шаги:
1. Ввести `blocked_test` / `Blocked123!`.
2. Нажать `Войти`.

Ожидаемый результат:
1. Вход не выполняется.
2. Сообщение: `Неверный логин или пользователь деактивирован`.

## RBAC-01 Ограничения оператора

Шаги:
1. Войти как `operator_test`.
2. Проверить раздел администрирования.
3. Открыть справочники и попытаться изменить запись.

Ожидаемый результат:
1. Админ-раздел недоступен или read-only.
2. Кнопки изменения справочников недоступны.

## RBAC-02 Ограничения на резервное копирование

Шаги:
1. Войти как `operator_test`.
2. Перейти в раздел резервных копий.
3. Нажать `Создать резервную копию`.

Ожидаемый результат:
1. Действие отклоняется по правам.
2. В аудит попадает событие `access_denied` по backup/reference.

## REF-01 CRUD справочников администратором

Шаги:
1. Войти как `admin_test`.
2. В справочниках создать `ICU-A` и `SURG-1`.
3. Создать тип материала `BLOOD`.
4. Отредактировать `BLOOD` -> `BLOOD-2`.
5. Удалить `BLOOD-2`.

Ожидаемый результат:
1. Все операции выполняются.
2. Таблица обновляется без перезапуска.
3. В аудит добавляются события изменений.

## REF-02 Валидация справочников

Шаги:
1. Попытаться создать отделение с пустым именем.
2. Попытаться создать ICD-10 без кода.
3. Попытаться создать дубликат `ICU-A`.

Ожидаемый результат:
1. Для пустых/дублирующих значений показывается ошибка валидации.
2. Некорректные записи не сохраняются.

## CTX-01 Выбор пациента по ID через PatientSelector

Шаги:
1. Перейти в модуль, где есть `PatientSelector`.
2. В поле `ID пациента` ввести корректный ID P1.
3. Нажать `Применить`.

Ожидаемый результат:
1. Показывается success-статус `Выбран: ...`.
2. Контекст пациента обновляется в связанных экранах.

## CTX-02 Невалидный ID в PatientSelector

Шаги:
1. В поле `ID пациента` ввести `abc`.
2. Нажать `Применить`.

Ожидаемый результат:
1. Показывается warning `ID пациента должен быть положительным числом`.
2. Поисковый диалог не открывается автоматически.

## CTX-03 Поиск пациента по ФИО (диалог)

Шаги:
1. Нажать `Найти` в `PatientSelector`.
2. Ввести `Иванов`.
3. Нажать `Поиск`.
4. Выбрать пациента двойным кликом.

Ожидаемый результат:
1. Пациент выбирается.
2. ID подставляется в selector.
3. Контекст обновляется.

## CTX-04 Проверка сброса контекста (анти-рекурсия)

Шаги:
1. Открыть кейс пациента (чтобы контекст был заполнен).
2. Выполнить действие `очистить контекст`/сброс выбора кейса.

Ожидаемый результат:
1. Контекст очищается во всех вкладках.
2. Нет зависания/RecursionError.

## EMZ-01 Создание новой госпитализации

Шаги:
1. Открыть ЭМЗ.
2. Заполнить данные пациента P1.
3. Ввести номер и/б `HC-2026-0001`, отделение `ICU-A`.
4. Заполнить даты:
   - травма `2026-02-01`
   - поступление `2026-02-02`
   - исход `2026-02-12`
5. Заполнить SOFA = `5`.
6. Добавить диагноз `admission` + `A41.9`.
7. Нажать `Сохранить`.

Ожидаемый результат:
1. Кейс и версия ЭМЗ сохраняются.
2. Поля вычислений (дни до поступления/длительность) заполняются корректно.
3. Появляется сообщение об успешном сохранении.

## EMZ-02 Версионирование ЭМЗ при редактировании

Шаги:
1. Открыть ранее созданный кейс C1.
2. Изменить SOFA `5 -> 7`.
3. Нажать `Сохранить`.

Ожидаемый результат:
1. Создается новая версия кейса.
2. Предыдущая версия перестает быть `current`.
3. В ЭМК/истории видно обновление.

## EMZ-03 Валидация дат ЭМЗ

Шаги:
1. В кейсе установить исход раньше даты поступления.
2. Нажать `Сохранить`.

Ожидаемый результат:
1. Сохранение блокируется.
2. Понятная ошибка валидации по датам.

## EMZ-04 Редактирование пациента через `PatientEditDialog`

Шаги:
1. В ЭМЗ нажать `Редактировать пациента`.
2. Изменить ФИО P1 на `Иванов Иван Ильич`.
3. Сохранить.

Ожидаемый результат:
1. Поля пациента в ЭМЗ обновляются.
2. ЭМК и контекст-бар обновляют ФИО.
3. Данные пациента синхронизированы во всех вкладках.

## LAB-01 Создание лабораторной пробы

Шаги:
1. Открыть модуль лаборатории для P1/C1.
2. Нажать `Новая проба`.
3. Выбрать материал `BLOOD`.
4. Ввести дату взятия `2026-02-02 09:10`.
5. Сохранить.

Ожидаемый результат:
1. Генерируется `lab_no` по шаблону `{MATCODE}-{YYYYMMDD}-{####}`.
2. Новая запись появляется в списке без ручного обновления.

## LAB-02 Заполнение результата и изолята

Шаги:
1. Открыть пробу из LAB-01.
2. Установить `growth_flag = 1`.
3. Заполнить:
   - `colony_desc = обильный рост`
   - `microscopy = грам+ кокки`
   - микроорганизм `Staphylococcus aureus`
4. Сохранить.

Ожидаемый результат:
1. Результаты сохраняются и отображаются в карточке/списке.

## LAB-03 Панель антибиотикочувствительности

Шаги:
1. В той же пробе открыть вкладку RIS/MIC.
2. Добавить строки:
   - `Цефтриаксон`, `R`, MIC `4`
   - `Меропенем`, `S`, MIC `0.25`
3. Сохранить.

Ожидаемый результат:
1. Строки панели сохраняются.
2. После повторного открытия значения не теряются.

## LAB-04 Панель бактериофагов

Шаги:
1. Открыть вкладку бактериофагов.
2. Добавить:
   - `Стафилококковый`, диаметр `18`
3. Сохранить.

Ожидаемый результат:
1. Данные сохраняются.
2. Невалидные значения (например `-1`) отклоняются.

## LAB-05 Фильтры и открытие из ЭМК

Шаги:
1. В ЭМК найти P1/C1.
2. Открыть лабораторию из карточки кейса.
3. Применить фильтры по дате и росту.

Ожидаемый результат:
1. Контекст пациента/кейса передается корректно.
2. Фильтрация возвращает только подходящие записи.

## SAN-01 Создание санитарной пробы

Шаги:
1. Открыть `Санитария`.
2. Выбрать отделение `ICU-A`.
3. Создать пробу:
   - точка: `Палата 101 / тумба`
   - дата взятия: `2026-02-03 10:00`
   - среда: `Эндо`
4. Сохранить.

Ожидаемый результат:
1. Запись появляется в истории отделения.
2. `lab_no` уникальный.

## SAN-02 Результат санитарной пробы и панели

Шаги:
1. Открыть созданную санитарную пробу.
2. Заполнить рост, микроорганизм и RIS-панель.
3. Сохранить.

Ожидаемый результат:
1. Данные сохраняются и отображаются в истории.

## SAN-03 Фильтры/пагинация истории

Шаги:
1. В истории санитарии применить фильтры:
   - диапазон дат;
   - growth_flag;
   - сортировка по дате.
2. Переключить страницы (если достаточно записей).

Ожидаемый результат:
1. Фильтры и сортировка корректны.
2. Пагинация работает без дубликатов и пропусков.

## AN-01 Поиск и агрегаты аналитики

Шаги:
1. Открыть `Аналитика`.
2. Установить период `2026-02-01` - `2026-02-29`.
3. Фильтр отделения: `ICU-A`.
4. Нажать `Поиск`.

Ожидаемый результат:
1. Таблица результатов заполняется.
2. Блок агрегатов (counts/top) соответствует данным стенда.

## AN-02 Фильтры микроорганизм + антибиотик

Шаги:
1. В аналитике выбрать фильтр:
   - микроорганизм `Staphylococcus aureus`;
   - антибиотик `Меропенем`.
2. Нажать `Поиск`.

Ожидаемый результат:
1. Возвращаются только релевантные пробы.
2. В выдаче нет дублирования одной пробы в нескольких строках.

## AN-03 Сохраненные фильтры

Шаги:
1. Сформировать сложный фильтр (даты + отделение + growth).
2. Сохранить как `ICU_GROWTH_FEB`.
3. Сбросить поля.
4. Применить сохраненный фильтр.
5. Удалить фильтр.

Ожидаемый результат:
1. Фильтр сохраняется, применяется и удаляется корректно.

## AN-04 Экспорт отчета и история артефактов

Шаги:
1. В аналитике выполнить `Экспорт XLSX`.
2. Выполнить `Экспорт PDF`.
3. Открыть блок `История отчетов`.
4. Нажать `Проверить выбранный`.

Ожидаемый результат:
1. В истории минимум 2 записи.
2. Для новых артефактов статус проверки хэша `ok`.
3. Двойной клик открывает файл артефакта.

## AN-05 Проверка mismatch артефакта

Шаги:
1. Сгенерировать отчет (см. AN-04).
2. Изменить файл отчета вручную (дописать любой текст в конец файла).
3. В истории нажать `Проверить выбранный`.

Ожидаемый результат:
1. Статус проверки меняется на `mismatch`.
2. Верификация `verified = false`.

## AN-06 Проверка отсутствующего артефакта

Шаги:
1. Сгенерировать отчет.
2. Удалить файл артефакта с диска.
3. Нажать `Проверить выбранный`.

Ожидаемый результат:
1. Статус проверки `missing`.
2. Верификация `verified = false`.

## EX-01 Экспорт через мастер (Excel/CSV/PDF/ZIP)

Шаги:
1. Открыть `Импорт/экспорт` -> мастер.
2. Выполнить по очереди:
   - Экспорт Excel (все таблицы).
   - Экспорт CSV (`patients`).
   - Экспорт PDF (`lab_sample` или `sanitary_sample`).
   - Экспорт ZIP.

Ожидаемый результат:
1. Каждый файл создается на диске.
2. В истории пакетов появляются 4 записи `export`.

## EX-02 Импорт CSV с ошибочной строкой

Шаги:
1. Через мастер выбрать `Импорт` -> `CSV` -> таблица `patients`.
2. Указать `patients_import.csv`.
3. Режим `merge`.
4. Выполнить импорт.

Ожидаемый результат:
1. Импорт завершен с предупреждением.
2. Валидная строка добавлена.
3. Невалидная строка попадает в `error_log_path`.
4. В summary есть `errors > 0`.

## EX-03 Импорт Excel с ошибочной строкой

Шаги:
1. Через мастер выбрать `Импорт` -> `Excel`.
2. Указать `patients_import.xlsx`.
3. Выполнить импорт.

Ожидаемый результат:
1. Аналогично EX-02: частичный успех + лог ошибок.

## EX-04 Импорт ZIP корректного пакета

Шаги:
1. Выбрать `Импорт` -> `ZIP`.
2. Указать `import_ok.zip`.
3. Выполнить импорт.

Ожидаемый результат:
1. Проверка SHA256 и schema_version проходит.
2. Импорт завершается успешно или частично успешно с прозрачной статистикой.

## EX-05 Импорт ZIP без `manifest.json`

Шаги:
1. Выбрать ZIP без `manifest.json`.
2. Запустить импорт.

Ожидаемый результат:
1. Импорт отклоняется с явной ошибкой про `manifest.json`.

## EX-06 Импорт небезопасного ZIP (`../evil.txt`)

Шаги:
1. Выбрать `import_unsafe.zip`.
2. Запустить импорт.

Ожидаемый результат:
1. Импорт отклоняется.
2. Сообщение содержит указание на небезопасный ZIP-путь.

## BACKUP-01 Создание резервной копии (admin)

Шаги:
1. Войти как `admin_test`.
2. Открыть админ-раздел.
3. Нажать `Создать резервную копию`.

Ожидаемый результат:
1. В статусе показывается созданный backup-файл.
2. В аудит добавляется событие backup.

## BACKUP-02 Восстановление из резервной копии (admin)

Шаги:
1. Подготовить валидный backup-файл.
2. В админ-разделе нажать `Восстановить из файла`.
3. Выбрать файл.

Ожидаемый результат:
1. Операция завершается сообщением `Перезапустите приложение`.
2. После перезапуска данные соответствуют backup.

## BACKUP-03 Ограничение бэкапа для operator

Шаги:
1. Войти как `operator_test`.
2. Открыть админ/backup блок (если доступен для чтения).
3. Попробовать создать или восстановить backup.

Ожидаемый результат:
1. Операция недоступна или отклонена с ошибкой прав.
2. В аудит добавляется `access_denied`.

## 7. Критерии приемки прогона

Прогон считается успешным, если:

1. Все сценарии `AUTH`, `RBAC`, `CTX`, `EMZ`, `LAB`, `SAN`, `AN`, `EX`, `BACKUP` пройдены без блокеров.
2. Нет рекурсивных падений и зависаний UI.
3. Нет silent-ошибок: все сбои показывают понятное сообщение пользователю.
4. История отчетов и пакетов обмена корректно отражает операции.
5. После теста сохраняется целостность БД (`integrity_check=ok`).
